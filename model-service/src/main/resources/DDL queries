
CREATE TABLE users (
    user_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(150) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    profile_photo_url TEXT DEFAULT NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL,

    PRIMARY KEY (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE media (
    media_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL,

    file_url TEXT NOT NULL,
    thumbnail_url TEXT DEFAULT NULL,

    mime_type VARCHAR(50) NOT NULL,
    size_bytes BIGINT UNSIGNED NOT NULL,

    width INT UNSIGNED DEFAULT NULL,
    height INT UNSIGNED DEFAULT NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,      -- upload time
    taken_at DATETIME DEFAULT NULL,                      -- EXIF time

    camera_model VARCHAR(100) DEFAULT NULL,

    location_lat DOUBLE DEFAULT NULL,
    location_lng DOUBLE DEFAULT NULL,

    status ENUM('active', 'deleted') DEFAULT 'active',

    PRIMARY KEY (media_id),

    INDEX idx_user_id (user_id),
    INDEX idx_taken_at (taken_at),
    INDEX idx_location (location_lat, location_lng),

    CONSTRAINT fk_media_user
        FOREIGN KEY (user_id) REFERENCES users(user_id)
        ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE albums (
    album_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL,

    name VARCHAR(150) NOT NULL,
    cover_media_id BIGINT UNSIGNED DEFAULT NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (album_id),

    INDEX idx_user_id (user_id),

    CONSTRAINT fk_album_user
        FOREIGN KEY (user_id) REFERENCES users(user_id)
        ON DELETE CASCADE,

    CONSTRAINT fk_album_cover_media
        FOREIGN KEY (cover_media_id) REFERENCES media(media_id)
        ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE album_media (
    album_media_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    album_id BIGINT UNSIGNED NOT NULL,
    media_id BIGINT UNSIGNED NOT NULL,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (album_media_id),

    UNIQUE KEY unique_album_media (album_id, media_id),

    CONSTRAINT fk_album_media_album
        FOREIGN KEY (album_id) REFERENCES albums(album_id)
        ON DELETE CASCADE,

    CONSTRAINT fk_album_media_media
        FOREIGN KEY (media_id) REFERENCES media(media_id)
        ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE shared_items (
    share_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,

    owner_user_id BIGINT UNSIGNED NOT NULL,
    shared_with_user_id BIGINT UNSIGNED NOT NULL,

    media_id BIGINT UNSIGNED DEFAULT NULL,
    album_id BIGINT UNSIGNED DEFAULT NULL,

    access_level ENUM('view', 'edit') DEFAULT 'view',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (share_id),

    INDEX idx_shared_with_user (shared_with_user_id),

    CONSTRAINT fk_shared_owner
        FOREIGN KEY (owner_user_id) REFERENCES users(user_id)
        ON DELETE CASCADE,

    CONSTRAINT fk_shared_with
        FOREIGN KEY (shared_with_user_id) REFERENCES users(user_id)
        ON DELETE CASCADE,

    CONSTRAINT fk_shared_media
        FOREIGN KEY (media_id) REFERENCES media(media_id)
        ON DELETE CASCADE,

    CONSTRAINT fk_shared_album
        FOREIGN KEY (album_id) REFERENCES albums(album_id)
        ON DELETE CASCADE
);

CREATE TABLE media_tags (
    media_id BIGINT UNSIGNED NOT NULL,
    tag_id BIGINT UNSIGNED NOT NULL,
    PRIMARY KEY (media_id, tag_id),

    FOREIGN KEY (media_id) REFERENCES media(media_id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(tag_id) ON DELETE CASCADE
);

CREATE TABLE tags (
    tag_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    PRIMARY KEY (tag_id),
    UNIQUE KEY unique_tag_name(name)
);

